{% extends 'base.html' %}
{% block title %}Inventaire{% endblock %}
{% block content %}
<div class="container py-4 animate__animated animate__fadeIn">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <h2 class="m-0"><i class="bi bi-box-seam"></i> Inventaire équipements</h2>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-orange" href="/inventory/export.csv"><i class="bi bi-download"></i> Export CSV</a>
      <a class="btn btn-outline-orange" href="/inventory/export.xlsx"><i class="bi bi-file-earmark-excel"></i> Export Excel</a>
    </div>
  </div>

  <div class="card glass p-4 mb-4">
    <form id="addForm" class="row g-2">
      <div class="col-sm-4"><input name="name" class="form-control" placeholder="Nom" required></div>
      <div class="col-sm-2"><input name="type" class="form-control" placeholder="Type"></div>
      <div class="col-sm-2"><input name="brand" class="form-control" placeholder="Marque"></div>
      <div class="col-sm-2"><input name="model" class="form-control" placeholder="Modèle"></div>
      <div class="col-sm-2"><button class="btn btn-orange w-100" type="submit"><i class="bi bi-plus-circle"></i> Ajouter</button></div>
      <div class="col-sm-3"><input name="software_version" class="form-control" placeholder="Version logicielle"></div>
      <div class="col-sm-3"><input name="ip_address" class="form-control" placeholder="IP de gestion"></div>
      <div class="col-sm-3"><input name="location" class="form-control" placeholder="Localisation"></div>
      <div class="col-sm-3"><input name="support_status" class="form-control" placeholder="Support (EoS)"></div>
      <div class="col-12"><input name="modules" class="form-control" placeholder="Modules"></div>
    </form>
  </div>

  <div class="table-responsive card glass p-3">
    <table class="table align-middle" id="invTable">
      <thead>
        <tr>
          <th>ID</th><th>Nom</th><th>Type</th><th>Marque</th><th>Modèle</th><th>IP</th><th>Localisation</th><th>Actions</th>
        </tr>
      </thead>
      <tbody>
      {% for it in items %}
        <tr data-id="{{it.id}}">
          <td>{{it.id}}</td>
          <td contenteditable="true">{{it.name}}</td>
          <td contenteditable="true">{{it.type}}</td>
          <td contenteditable="true">{{it.brand}}</td>
          <td contenteditable="true">{{it.model}}</td>
          <td contenteditable="true">{{it.ip_address}}</td>
          <td contenteditable="true">{{it.location}}</td>
          <td>
            <button class="btn btn-sm btn-outline-orange save"><i class="bi bi-save"></i></button>
            <button class="btn btn-sm btn-outline-danger delete"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  // Add equipment
  const addForm = document.getElementById('addForm');
  addForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(addForm).entries());
    const res = await fetch('/inventory/add', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    if (res.ok) location.reload();
  });

  // Save and Delete actions
  document.querySelectorAll('#invTable tbody tr').forEach((tr) => {
    const id = tr.getAttribute('data-id');
    tr.querySelector('.save')?.addEventListener('click', async () => {
      const tds = tr.querySelectorAll('td');
      const payload = {
        name: tds[1].textContent.trim(),
        type: tds[2].textContent.trim(),
        brand: tds[3].textContent.trim(),
        model: tds[4].textContent.trim(),
        ip_address: tds[5].textContent.trim(),
        location: tds[6].textContent.trim(),
      };
      const res = await fetch(`/inventory/${id}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (res.ok) alert('Enregistré.');
    });
    tr.querySelector('.delete')?.addEventListener('click', async () => {
      if (!confirm('Supprimer cet équipement ?')) return;
      const res = await fetch(`/inventory/${id}`, { method: 'DELETE' });
      if (res.ok) tr.remove();
    });
  });
</script>
{% endblock %}